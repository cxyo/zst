# 基金净值走势可视化工具

## 项目简介

本项目是一个用于获取基金历史净值数据并生成可视化交互式图表的Python工具。通过调用东方财富网的公开API接口，抓取指定基金的历史净值数据，经过数据处理和格式化后，使用pyecharts图表库生成美观、交互式的净值走势图网页。用户只需运行程序，即可获取最新基金数据并生成直观的可视化图表。

该工具特别适合需要进行基金投资分析的用户，支持多基金同时对比展示，帮助投资者快速了解不同基金的净值走势和相对表现。生成的HTML文件可以直接在浏览器中打开，支持缩放、悬停查看详情、数据导出等交互功能，无需部署Web服务器即可独立运行。

## 核心功能

本工具提供了完整的基金数据获取、图表生成和导出功能，满足用户对基金净值分析的基本需求。首先，工具支持批量获取多个基金的净值历史数据，用户可以通过配置文件灵活配置需要跟踪的基金列表，默认包含了沪深300、中证500、中证红利、中证国防、中证军工、芯片、机器人、人工智能、5G、云计算、恒生指数、标普500等十二个主流指数基金和行业ETF。其次，工具会自动从东方财富网API获取最新的净值数据，确保数据的及时性和准确性，每次运行都会请求最新数据，用户无需手动更新。此外，生成的图表具有丰富的交互功能，包括鼠标悬停查看具体数值、框选缩放查看细节、滑动条快速导航、图例点击切换显示等，大大提升了数据分析的便利性。工具还支持保存图片和数据视图，用户可以将图表导出为PNG图片，或者查看底层数据表格，便于进一步分析或报告使用。最后，工具采用面向对象的设计架构，代码结构清晰，扩展性强，用户可以方便地添加新功能或修改现有配置。

## 技术架构

### 编程语言与版本要求

本项目使用Python 3.7及以上版本开发，充分利用了Python的动态类型特性和丰富的第三方库支持。Python 3.7引入了dataclass装饰器和更完善的类型提示系统，使得代码更加清晰易维护。建议用户使用Python 3.8或更高版本，以获得更好的性能优化和语法支持。在Windows操作系统上，Python 3.7至3.11版本均经过测试，可以正常运行本项目。

### 核心依赖库

本项目依赖以下三个核心Python库来实现其功能。requests库用于发送HTTP请求，从东方财富网API获取基金净值数据。requests是Python最流行的HTTP库，提供了简洁易用的API，支持连接池、超时控制、重试机制等高级功能，能够高效稳定地进行网络请求。pandas库是Python数据科学领域的核心工具，用于数据的存储、处理和分析。在本项目中，pandas主要用于将原始数据转换为DataFrame格式，方便进行数据筛选、计算和统计操作，同时提供了丰富的数据处理函数支持复杂的数据转换逻辑。pyecharts是Apache ECharts的Python绑定库，专门用于生成交互式数据可视化图表。pyecharts提供了丰富的图表类型和配置选项，能够生成支持缩放、悬停、导出等交互功能的HTML图表，非常适合展示金融数据的时间序列变化。

### 第三方库版本要求

为了确保项目稳定运行，需要安装以下指定版本的依赖库。requests版本要求2.32.3或更高，该版本修复了多个安全漏洞并优化了性能表现。pandas版本要求2.2.3或更高，该版本引入了更高效的数据结构和Arrow后端支持，显著提升了数据处理速度。pyecharts版本要求2.0.9或更高，该版本支持最新的ECharts特性并修复了已知的渲染问题。这些版本要求已经在requirements.txt文件中明确指定，用户只需执行pip安装命令即可自动安装正确的版本。

### 技术特性

本项目采用多项技术手段确保程序稳定运行和数据安全。在请求频率控制方面，项目实现了智能请求间隔机制，通过FundDataFetcher类中的_ensure_request_interval方法，确保每次API请求之间保持0.5秒的时间间隔。这一设计有效避免了对目标服务器的过度请求，降低了被封禁的风险，同时体现了对公共API资源的合理使用态度。在HTML渲染方面，项目采用自定义标题div与pyecharts图表分离的技术方案，标题区域通过独立的HTML元素渲染，与图表内容完全分离，避免了标题与图表内容重叠的问题，提升了图表的可读性和专业性。

## 设计原理

### 数据获取层设计

数据获取层由FundDataFetcher类负责，该类的设计遵循了单一职责原则，只关注如何从外部API获取原始数据，不涉及任何数据处理逻辑。这种设计使得数据获取逻辑可以独立测试和复用，也便于将来替换数据源而无需修改其他代码。

FundDataFetcher类实现了动态回调函数生成机制。由于东方财富网的基金净值API采用JSONP格式返回数据，请求中需要包含正确的回调函数名才能正常获取数据。类中的_generate_timestamp方法会生成符合API要求的时间戳和回调函数格式，确保每次请求都是唯一的，避免API服务器的缓存机制影响数据获取。同时，类中预置了模拟浏览器的请求头信息，包括Referer和User-Agent字段，这些字段是API服务器验证请求来源的重要依据，缺少这些字段可能导致请求被拒绝。

在错误处理方面，FundDataFetcher类采用了多层异常捕获机制。网络请求可能遇到的异常包括连接超时、DNS解析失败、SSL错误等RequestException子类，这些异常通常表示网络层面的问题。JSON解析异常和数据格式异常由json.JSONDecodeError和KeyError捕获，表示API返回的数据格式不符合预期。最后的通用异常捕获作为安全网，确保任何意外情况都不会导致程序崩溃。这种分层的错误处理策略使得程序能够在不同层级上给出准确的错误信息，帮助用户定位问题原因。

### 请求频率控制机制

请求频率控制是本项目的重要技术特性之一。FundDataFetcher类中定义了REQUEST_INTERVAL类变量，默认值为0.5秒，表示两次请求之间的最小时间间隔。_ensure_request_interval方法实现了频率控制的核心逻辑：首先获取当前时间戳，计算与上次请求时间的差值；如果差值小于设定的间隔时间，则通过time.sleep方法进行等待；等待完成后更新最后请求时间并执行实际的网络请求。这种设计确保了即使在批量获取多个基金数据时，也能够保持合理的请求频率，避免对目标服务器造成过大压力。

该机制的实现采用了类变量_last_request_time来记录最后一次请求的时间戳，通过类方法的方式实现全局共享。这意味着无论调用多少次get_fund_nav_data方法，都能够保持统一的请求频率控制，不需要额外的状态管理。0.5秒的间隔时间是在充分测试后确定的安全值，既能够保证数据获取的效率，又能够有效避免被服务器封禁的风险。

### 数据处理层设计

数据处理层由FundDataProcessor类负责，该类实现了基金数据的批量获取、格式转换和对齐处理功能。设计上采用了类方法而非静态方法，这样做的目的是保持代码的一致性和可测试性，同时为将来可能的继承扩展留出空间。

数据对齐是本工具的核心技术难点之一。由于不同基金可能存在交易日差异，例如某只基金在某一天因特殊情况暂停交易，而其他基金正常交易，这会导致各基金的数据长度和日期不完全一致。为了解决这个问题，FundDataProcessor采用了索引对齐策略：反转原始数据使时间从早到晚排列，然后使用统一的索引系统，将所有基金的数据按相同索引对齐。日期信息只记录一次，存储在date_mapping字典中，各基金净值数据通过索引与日期关联。这种设计确保了图表展示时各基金的时间轴完全一致，便于进行横向对比分析。

Y轴范围计算是另一个重要的数据处理逻辑。calculate_yaxis_range方法根据数据的最大值和最小值计算合适的Y轴显示范围，默认留出8%的边距使图表视觉效果更好。对于基金净值这类始终为正数的数据，方法还特别确保计算出的最小值不会小于0，避免出现负数Y轴的异常情况。计算结果保留四位小数，既保证了精度，又避免了过长的数字显示影响图表美观。

### 图表生成层设计

图表生成层由FundChartGenerator类负责，该类是整个应用的用户界面层，直接决定了最终输出的图表样式和交互体验。类中定义了两套基金配置方案：FUND_CONFIG使用ETF基金代码（以5或1开头），而ALTERNATIVE_FUND_CONFIG使用场外基金代码（以0开头）。用户可以通过构造函数的use_alternative参数灵活切换配置方案，这种设计为用户提供了更多的选择空间。

图表生成采用链式配置模式。首先创建Line对象并设置初始化参数，包括图表主题、尺寸和页面标题。然后依次添加X轴数据、Y轴数据系列，每添加一个系列都配置相应的样式选项。这种分步配置的方式使得代码逻辑清晰，便于理解和维护。图表尺寸默认设置为1400px×800px，较大的显示区域确保了多基金数据能够清晰展示。

HTML输出优化是本项目的技术亮点之一。save_chart_to_html方法在生成基础HTML文件后，会进行后处理操作：读取生成的HTML内容，使用正则表达式匹配图表容器div的正则模式，将自定义标题div插入到图表div之前。标题div采用内联样式设计，包含浅灰色背景和底部边框，与主图表区域形成清晰的视觉分隔。标题文字采用微软雅黑字体，确保在中文Windows系统上的最佳显示效果。这种后处理技术方案避免了pyecharts内置标题与自定义标题的冲突，实现了更灵活的页面布局控制。

### 交互设计

交互设计是本工具的重要特色。图表配置了两种数据缩放方式：内置型数据区域缩放支持鼠标滚轮缩放和框选缩放，适合精确查看数据细节；滑块型数据区域缩放提供了可视化的缩放控制条，适合快速导航到指定时间范围。图例配置为滚动模式，当基金数量较多时可以左右滚动查看，避免图例重叠。工具箱提供了保存图片、数据视图、还原和区域缩放四个常用功能，满足用户导出和进一步分析的需求。

## API接口说明

### 数据源接口

本项目使用东方财富网提供的基金历史净值接口获取数据。接口的基础URL为http://api.fund.eastmoney.com/f10/lsjz，这是一个公开的免费接口，无需注册或申请API密钥即可使用。接口采用RESTful设计风格，支持HTTP GET请求方式，返回JSONP格式的数据。

### 请求参数说明

调用该API需要传递以下参数。callback参数指定JSONP回调函数名，格式为jQuery_{timestamp}_{sequence}，其中timestamp是13位毫秒时间戳，sequence是与时间戳相关的序列号。fundCode参数为目标基金代码，为6位数字字符串，例如510310表示华夏沪深300ETF。pageIndex参数指定请求页码，从1开始计数。pageSize参数指定每页返回的记录数量，默认最大值为60条。startDate和endDate参数用于筛选日期范围，格式为YYYY-MM-DD，为空时表示不限制日期范围。_参数是另一个时间戳，用于防止缓存和提高请求的唯一性。

### 返回数据格式

API返回的数据采用JSONP格式，外层是回调函数调用，内层是JSON数据。成功返回时，JSON数据的ErrCode字段为0，Data字段包含实际数据，LSJZList字段是净值记录列表。每条净值记录包含以下主要字段：FSRQ字段为净值日期，格式为YYYY-MM-DD；DWJZ字段为单位净值，表示每份基金的净值；ACCUM字段为累计净值，表示考虑分红再投资后的净值；DailyGrowth字段为日增长率，表示当日的净值变化百分比。

## 安装与部署

### 环境准备

在安装本项目之前，需要确保系统中已经安装了Python 3.7或更高版本。用户可以通过在命令行中执行python --version命令来检查Python版本。如果系统中未安装Python或版本过低，建议从Python官方网站（https://www.python.org/downloads/）下载并安装最新版本的Python。安装过程中请务必勾选Add Python to PATH选项，以便后续命令可以正常执行。

### 安装依赖库

本项目的依赖库已记录在requirements.txt文件中，用户只需执行一条pip命令即可完成所有依赖的安装。首先打开命令行终端，进入项目目录基金的目录，然后执行以下命令安装依赖。Windows系统用户请使用pip install -r requirements.txt命令，macOS和Linux系统用户可以使用pip3 install -r requirements.txt命令。pip会自动下载并安装requests、pandas和pyecharts三个库及其依赖项。

安装过程通常需要几分钟时间，具体取决于网络连接速度和计算机性能。如果遇到网络超时问题，可以尝试使用国内镜像源加速下载，例如执行pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple命令使用清华大学镜像源。如果系统中存在多个Python版本，建议使用python -m pip install -r requirements.txt命令明确指定Python版本。

### 创建虚拟环境（推荐）

为了更好地管理项目依赖，建议在项目目录下创建Python虚拟环境。执行以下命令创建虚拟环境并激活：创建虚拟环境使用python -m venv .venv命令，激活虚拟环境在Windows系统上使用.venv\Scripts\activate命令，在macOS和Linux系统上使用source .venv/bin/activate命令。激活虚拟环境后，再执行pip install -r requirements.txt命令安装依赖。所有后续运行操作都应在激活虚拟环境后进行。

### 运行程序

安装完成后，用户可以通过以下方式运行程序。在命令行中进入项目目录，确保虚拟环境已激活（如果使用了虚拟环境），执行python app.py命令即可启动程序。程序启动后会依次执行数据获取、数据处理和图表生成三个阶段，每个阶段都会在控制台输出相应的日志信息。正常情况下，程序会在当前目录下生成一个名为index.html的文件，该文件包含了完整的交互式图表。

程序运行时会显示进度信息，包括正在获取数据的基金名称、已获取的数据条数、生成图表的进度等。如果出现错误，控制台会显示详细的错误信息和堆栈跟踪，便于定位问题原因。程序运行完成后，会显示生成的HTML文件路径，用户可以使用浏览器打开该文件查看交互式图表。

### 查看图表

用户可以使用任意现代浏览器打开index.html文件查看图表。Chrome、Firefox、Edge、Safari等主流浏览器均支持图表的全部功能。图表支持鼠标滚轮缩放、框选缩放、悬停查看数据、点击图例切换显示等交互操作，右上角的工具箱还提供了保存图片和数据视图等功能。

图表页面顶部显示标题区域，包含主标题"基金净值走势图"和副标题信息（数据更新日期和交易日数量）。标题区域采用浅灰色背景，与下方的图表区域形成清晰的视觉分隔。图表主体采用浅色主题，支持数据缩放、工具提示、图例切换等交互功能。

### 自定义配置

用户可以根据需要修改FundChartGenerator类中的基金配置。FUND_CONFIG字典定义了主配置方案，使用ETF基金代码，适合希望通过二级市场交易基金的用户。ALTERNATIVE_FUND_CONFIG字典定义了备选配置方案，使用场外基金代码，适合通过银行或第三方平台购买基金的用户。只需在创建FundChartGenerator对象时设置相应的use_alternative参数，即可切换不同的配置方案。

用户也可以直接修改字典中的基金名称和代码，添加自己关注的基金。基金代码必须是东方财富网支持的6位代码，建议从东方财富网基金页面（http://fund.eastmoney.com/）查询确认。修改配置后重新运行程序，即可生成包含自定义基金列表的图表。

## 目录结构

项目目录结构简洁明了，包含以下文件和文件夹。app.py是主程序文件，包含了所有业务逻辑代码，包括FundDataFetcher数据获取类、FundDataProcessor数据处理类、FundChartGenerator图表生成类以及main主函数。old_app.py是原始版本的程序文件，保留了历史版本供参考对比。requirements.txt记录了项目依赖的第三方库及其版本要求。index.html是程序运行时生成的图表输出文件，每次运行都会重新生成。

## 常见问题

### 网络请求失败

如果程序运行时出现网络请求失败的错误提示，可能是以下原因导致的。首先检查网络连接是否正常，可以尝试访问东方财富网基金页面（http://fund.eastmoney.com/）确认网络连通性。其次检查请求头信息是否正确，API服务器可能会拒绝缺少正确User-Agent的请求。程序已经内置了模拟浏览器的请求头，通常不会因为请求头问题导致失败。此外，部分网络环境可能会对特定域名进行限制或限速，可以尝试切换网络环境或使用代理服务器。

### 数据解析异常

如果程序能够成功获取数据但在解析阶段出现异常，可能是API返回的数据格式发生了变化。东方财富网可能会不定期调整API接口的返回格式，导致正则表达式匹配或JSON解析失败。这种情况下，首先查看错误信息确定具体的失败位置，然后根据API实际返回的数据调整解析逻辑。建议在遇到此类问题时保留API返回的原始数据，以便进行调试和问题排查。

### 图表显示异常

如果生成的HTML文件在浏览器中显示异常，可能的原因包括浏览器版本过低、JavaScript被禁用、文件编码问题等。建议使用Chrome、Firefox或Edge的最新版本浏览器打开图表，并确保浏览器已启用JavaScript支持。如果图表部分功能无法使用，可以尝试刷新页面或清除浏览器缓存。部分单位或公司网络可能会过滤特定的JavaScript代码，也可能导致图表功能受限。

### 请求被封禁

如果在运行程序时出现大量请求失败的错误，可能是因为请求频率过高导致IP被临时封禁。程序已经内置了0.5秒的请求间隔机制，通常不会出现此问题。但如果使用其他方式（如多进程并发请求）调用API接口，可能会触发封禁机制。建议遵守API的使用规范，避免短时间内发送大量请求。如果已被封禁，可以等待一段时间后重试，或更换IP地址。

### 图表标题重叠

如果生成的图表出现标题与内容重叠的情况，请确保使用的是最新版本的程序。旧版本可能使用pyecharts内置的标题选项，导致标题与图表区域重叠。最新版本采用HTML自定义标题方案，标题区域与图表区域完全分离，不会出现重叠问题。如仍有问题，请检查浏览器缩放设置，确保使用100%的缩放比例查看页面。

## 扩展开发

本项目的面向对象设计使得扩展开发变得简单直接。如果需要添加新的数据源，可以创建继承自FundDataFetcher的新类，实现相同的接口方法，在_get_fund_nav_data方法中实现自定义的数据获取逻辑。如果需要添加新的图表类型，可以参考FundChartGenerator类的设计，创建新的图表生成器类，参考generate_chart方法实现图表配置逻辑。如果需要添加定时自动运行功能，可以使用Windows任务计划程序或Linux cron定时任务来定期执行程序脚本，通过设置定时任务实现每日自动更新图表。如果需要实现Web服务化部署，可以将图表生成逻辑封装为API接口，使用Flask或Django框架提供Web服务，实现多人共享访问的Web应用。

### 添加新的基金配置

要添加新的基金配置，只需修改FundChartGenerator类中的FUND_CONFIG或ALTERNATIVE_FUND_CONFIG字典。键为基金显示名称（用于图例和提示信息），值为基金代码（6位数字）。例如添加"中证医疗"基金：'中证医疗': '512170'。修改后重新运行程序即可在图表中看到新增的基金数据。

### 调整请求间隔

要调整请求间隔时间，只需修改FundDataFetcher类中的REQUEST_INTERVAL类变量。当前设置为0.5秒，表示每次请求之间等待0.5秒。如果网络环境较好且API响应迅速，可以适当降低该值以提高获取速度；如果网络环境较差或担心被封禁，可以增加该值以降低请求频率。修改REQUEST_INTERVAL = 1.0可将间隔增加到1秒。

## 注意事项

本项目使用的数据来源是东方财富网的公开API接口，这些接口可能会在不经通知的情况下发生变化或关闭。如果API接口发生重大变更，可能需要修改程序代码以适配新的接口规范。建议用户定期关注API的变化情况，并及时更新程序代码。

本项目仅用于学习和研究目的，请勿将其用于商业用途或高频交易。使用本项目产生的数据进行投资决策时，请务必自行核实数据的准确性和完整性，并充分了解投资风险。基金投资有风险，入市需谨慎。

本项目内置的请求频率控制机制是为了遵守API使用规范而设计的，请勿绕过该机制或修改代码以提高请求频率。过度请求可能会导致IP被封禁，影响所有用户的正常使用。

## 版本历史

当前版本为2.1，相比2.0版本进行了界面优化和稳定性增强。主要更新内容包括：优化了图表标题的显示方式，将标题区域与图表区域完全分离，采用独立的HTML div元素渲染，避免了标题与图表内容重叠的问题。标题区域采用浅灰色背景和底部边框设计，提升了图表的整体美观性和可读性。修复了pyecharts版本兼容性问题，移除了可能不兼容的GraphicTextItem配置，改用更稳定的标准配置方案。优化了HTML输出逻辑，使用正则表达式匹配图表容器，确保标题能够正确插入到任意生成的图表div之前。

2.0版本实现了面向对象重构，代码结构从面向过程重构为面向对象，提高了代码的可维护性和可扩展性。添加了日志系统，替代原有的print语句输出，便于问题排查和程序监控。修复了回调函数生成的bug，确保API请求参数的一致性。完善了类型注解，提高了代码的可读性和IDE支持。添加了完整的文档注释，增强了代码的自解释性。

## 许可证

本项目采用MIT许可证开源，您可以自由使用、修改和分发本项目的代码，但需要保留原始的版权声明和许可证文本。
