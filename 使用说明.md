# 基金净值走势图自动更新系统 - 技术文档

## 一、项目概述

本项目是一个自动化基金净值数据抓取与可视化展示系统，通过爬取东方财富网的基金历史净值数据，利用 Python 进行数据处理和分析，最终生成交互式基金净值走势图。项目支持本地运行和云端部署两种模式，配合 GitHub Actions 可实现每日自动更新功能。

该系统的主要功能包括：自动从网络获取基金净值数据、支持多基金品种同时展示、生成可交互的净值走势图、每日定时自动更新、数据持久化存储。通过 pyecharts 库生成的图表支持缩放、鼠标悬停查看详细数据、点击图例隐藏/显示特定基金等交互功能。

## 二、技术架构

### 2.1 后端技术栈

Python 作为本项目的主要开发语言，其简洁的语法和丰富的第三方库使得数据处理和网络爬虫开发变得高效便捷。项目使用 Python 3.11 或更高版本，充分利用其类型注解、f-string 格式化等现代语言特性。

requests 库负责 HTTP 请求处理，该库提供了简洁的 API 用于发送 GET/POST 请求，支持会话管理、重试机制、超时设置等功能。在本项目中，我们设置 30 秒超时时间，防止网络请求无限期挂起，同时添加了完善的异常处理机制，确保单个基金请求失败不会影响整体流程。

pandas 库是 Python 数据分析的核心工具，在本项目中主要用于数据清洗、转换和结构化处理。原始基金净值数据以列表形式存储，通过 pandas 转换为 DataFrame 格式，便于后续的数据分析和图表绑制。

pyecharts 是百度开源的可视化图表库，支持生成交互式的 HTML 图表。与静态图片不同，pyecharts 生成的图表可以在浏览器中进行缩放、悬停查看数据点、点击图例切换显示等操作，大大提升了用户体验。该库生成的图表是纯 HTML 和 JavaScript 代码，可以直接嵌入任何网页中。

### 2.2 前端技术栈

项目生成的图表采用 HTML5 + JavaScript + CSS3 技术构建，所有图表逻辑封装在生成的 HTML 文件中。pyecharts 库底层使用 ECharts 作为渲染引擎，ECharts 是百度开源的 Apache 顶级开源项目，拥有优秀的渲染性能和丰富的图表类型。

图表的响应式设计确保在不同尺寸的屏幕上都能正常显示。图表宽度设置为 1200 像素，高度设置为 500 像素，这些参数可以通过配置文件进行调整以适应不同场景的需求。

## 三、数据源详解

### 3.1 数据来源

本项目的数据来源于东方财富网的基金历史净值接口。东方财富网是国内最大的财经门户之一，其基金数据中心提供了权威、准确的基金净值数据。数据接口地址为：`http://api.fund.eastmoney.com/f10/lsjz`，该接口返回指定基金的历史净值记录。

接口采用 GET 请求方式，支持以下参数：fundCode 为基金代码，如 160119 代表中证 500 指数；pageIndex 为页码，从 1 开始；pageSize 为每页记录数，默认 20 条；startDate 和 endDate 为可选的日期范围筛选参数。接口还要求设置正确的 Referer 和 User-Agent 请求头，否则可能被服务器拒绝。

值得注意的是，该接口返回的数据格式为 JSONP，响应体被一个 JavaScript 函数调用包裹，类似于 `jQuery1830041192874394646584_1617938643457({"Data": {...}})`。因此我们需要使用正则表达式提取括号内的 JSON 数据，然后进行解析。

### 3.2 数据字段说明

接口返回的 JSON 数据中，每条净值记录包含以下字段：FSRQ 为净值日期，格式为 YYYY-MM-DD；DWJZ 为单位净值，即每份基金的单位价值；LJJZ 为累计净值，考虑了基金分红再投资后的净值；JZZZL 为增长率，表示与上一日相比的涨跌百分比；SGZT 为申购状态，开放或暂停；SHZT 为赎回状态。

在本项目中，我们主要使用 FSRQ 和 DWJZ 两个字段，分别对应图表的 X 轴（日期）和 Y 轴（净值）。通过对比不同基金的历史净值走势，投资者可以直观地了解各基金的表现差异。

### 3.3 数据获取流程

数据获取流程遵循以下步骤：首先构建完整的请求 URL，将基金代码、页码、每页数量等参数拼接成标准格式；然后设置必要的请求头，Referer 设置为东方财富基金页面，User-Agent 设置为常见的浏览器标识；接着发送 HTTP GET 请求并等待响应，设置 30 秒超时防止请求挂起；响应成功后使用正则表达式提取 JSON 数据；最后将 JSON 字符串解析为 Python 字典对象。

整个过程中添加了完善的异常处理机制。requests.RequestException 捕获所有与网络请求相关的错误，如连接超时、DNS 解析失败、服务器返回错误状态码等。json.JSONDecodeError 捕获 JSON 解析错误，应对可能的响应格式变化。通用 Exception 捕获其他未预期的错误，确保程序不会因单个基金请求失败而崩溃。

## 四、核心算法与计算公式

### 4.1 净值增长率计算

净值增长率是衡量基金收益的重要指标，计算公式为：增长率 = (当日净值 - 上一日净值) / 上一日净值 × 100%。该指标反映了基金单日的涨跌幅度，正值表示上涨，负值表示下跌。

在本项目中，增长率数据直接从接口返回的 JZZZL 字段获取，该字段已经是计算好的百分比数值。如果需要手动计算，可参考以下 Python 代码：`growth_rate = (current_nav - previous_nav) / previous_nav * 100`。

### 4.2 Y轴动态范围计算

为了使图表美观且信息丰富，Y 轴的范围需要根据数据动态计算。计算公式为：Y轴最大值 = 数据最大值 × 1.08；Y轴最小值 = 数据最小值 × 0.92。乘以 1.08 和 0.92 的系数是为了在数据点和坐标轴之间留出适当的空间，使图表视觉效果更佳。

在代码实现中，使用 pandas 的 max() 和 min() 方法获取数据的最大值和最小值，然后应用上述系数计算 Y 轴范围。最终结果保留 4 位小数，通过 round() 函数实现四舍五入。Y 轴的刻度间隔设置为 0.02，确保坐标轴标注清晰可读。

### 4.3 多基金数据对齐

由于不同基金可能存在交易日差异（节假日休市导致部分基金无数据），在绑定到同一图表时需要进行数据对齐。系统采用反向遍历的方式处理数据，从最新数据开始向前填充，确保所有基金共享相同的日期序列。

具体实现中，首先创建空的日期字典和基金数据字典，然后遍历每个基金获取其净值数据。对于每个基金的数据，从最新记录开始依次填充到日期字典和基金数据字典中。这样处理后，所有基金共享同一个索引到日期的映射关系，确保图表 X 轴的一致性。

## 五、图表功能说明

### 5.1 图表类型与配置

项目使用折线图（Line Chart）作为主要图表类型，折线图非常适合展示连续时间序列数据的趋势变化。每个基金品种对应一条折线，通过不同的颜色和图例进行区分。图表支持以下交互功能：鼠标悬停显示详细数据点信息、拖拽缩放查看特定时间段、双击重置缩放、点击图例隐藏或显示特定基金。

图表的初始化配置包括：主题设置为 LIGHT（浅色主题），宽度 1200 像素，高度 500 像素。这些参数位于 app.py 的 opts.InitOpts 中，可根据实际需求进行调整。

### 5.2 标记点与标记线

为了丰富图表的信息展示，每个基金的折线添加了最大值和最小值标记点，以及平均值参考线。最大/最小值标记使用 pyecharts 的 MarkPointOpts 配置，这些标记点会自动标注在数据的最值位置，并在鼠标悬停时显示具体数值。

平均值参考线使用 MarkLineOpts 配置，在图表上显示该基金的平均水平线。这条虚线横跨整个图表宽度，便于快速判断当前价格是高于还是低于历史平均水平。

### 5.3 数据缩放组件

图表底部配置了数据缩放组件（DataZoomOpts），允许用户通过滑动条或鼠标滚轮缩放 X 轴范围。这对于查看长期趋势或短期波动都非常有用。缩放组件位于图表底部，占据适当高度，不影响主体图表的展示。

## 六、本地部署指南

### 6.1 环境准备

本地运行本项目需要准备以下环境：首先安装 Python 3.11 或更高版本，可从 Python 官网下载安装包或通过 Anaconda 管理。然后克隆或下载项目代码到本地目录。项目目录结构如下：根目录包含 README.md、index.html、app.py、requirements.txt 和使用说明文档，.github 文件夹包含 GitHub Actions 工作流配置。

### 6.2 安装依赖

打开终端（Windows 下为 PowerShell 或命令提示符），进入项目目录执行以下命令安装依赖包。首先升级 pip 包管理器：`python -m pip install --upgrade pip`。然后安装项目依赖：`cd 基金历史净值flask` 后执行 `pip install -r requirements.txt`。

requirements.txt 文件包含以下依赖及其版本：requests 2.32.3 用于网络请求，pandas 2.2.3 用于数据处理，pyecharts 2.0.9 用于图表生成。安装过程会自动处理依赖关系，确保所有包兼容。

### 6.3 运行程序

依赖安装完成后，执行以下命令运行程序：`python app.py`。程序启动后会依次执行以下操作：输出开始运行日志；检查 docs 目录是否存在，不存在则创建；遍历配置的所有基金获取净值数据；将数据转换为 DataFrame 格式；绑定数据生成图表；将图表渲染为 HTML 文件并保存到 index.html；输出运行结果和文件路径。

运行成功后，控制台会显示 "文件创建成功" 的提示。生成的 index.html 文件可以用任意现代浏览器打开查看交互式图表。

### 6.4 自定义基金配置

要添加、删除或修改基金品种，编辑 app.py 文件中的 CONFIG 字典。funds 数组包含所有基金配置，每个基金是一个包含 name 和 code 键的字典。例如添加一只新的基金：`{"name": "沪深300", "code": "000311"}`。修改完成后重新运行程序即可生成包含新基金的图表。

## 七、云端部署方案

### 7.1 GitHub Pages 部署

GitHub Pages 是 GitHub 提供的静态网站托管服务，适合部署本项目生成的静态 HTML 文件。部署步骤如下：首先将项目推送到 GitHub 仓库，确保 docs 目录和 index.html 文件被包含在版本控制中。进入仓库设置页面，找到 Pages 选项卡，Source 选择 "main" 分支（或 master 分支），保存设置后等待几分钟，GitHub 会生成访问地址。

访问地址格式为：`https://你的用户名.github.io/仓库名/`。由于 GitHub Actions 会自动每天更新 docs/index.html，网页内容会保持最新。GitHub Pages 支持自定义域名，只需要在仓库根目录添加 CNAME 文件并配置 DNS 即可。

### 7.2 Vercel 部署

Vercel 是另一个优秀的静态网站托管平台，特别适合前端项目。部署步骤：首先在 Vercel 官网使用 GitHub 账号登录并授权。然后点击 "Add New Project" 选择本项目的 GitHub 仓库。Vercel 会自动检测项目类型，由于我们是纯静态文件，直接点击 "Deploy" 即可。部署完成后会获得一个访问地址，支持自定义域名。

Vercel 的优势在于部署速度快、支持 Serverless Functions、全球 CDN 加速。如果需要更复杂的自定义行为，可以添加 Serverless Functions 处理数据抓取逻辑。

### 7.3 腾讯云静态网站托管

如果面向国内用户，推荐使用腾讯云静态网站托管服务。登录腾讯云控制台，进入对象存储 COS 服务，创建一个存储桶并开启静态网站功能。将生成的 index.html 和相关资源上传到存储桶，配置正确的索引文档为 index.html，设置访问权限为公开读取。腾讯云会提供一个默认域名，也可以绑定自定义域名。

COS 的优势在于：国内访问速度快、费用低廉、支持 CDN 加速、可与其他腾讯云服务集成。

### 7.4 阿里云 OSS 部署

阿里云对象存储服务（OSS）同样支持静态网站托管。创建 OSS Bucket 后，进入基础设置开启静态网站功能，设置默认首页为 index.html，404 页面可选择设置或不设置。将本地生成的 index.html 和 pyecharts 生成的 assets 文件夹一起上传到 Bucket，设置为公开读取。访问地址格式为：`BucketName.Endpoint.aliyuncs.com/index.html`。

阿里云 OSS 支持绑定自定义域名、全球 CDN 加速，适合对访问速度有较高要求的场景。

## 八、定时任务配置

### 8.1 GitHub Actions 自动更新

项目已配置 GitHub Actions 工作流，实现每日自动更新功能。工作流文件位于 `.github/workflows/update-fund-data.yml`，包含以下触发条件：计划触发每天 UTC 时间 9:00 执行（对应北京时间 17:00）；手动触发可通过 GitHub 界面操作；代码变更触发当 app.py 或 requirements.txt 发生变化时自动运行。

工作流执行步骤包括：Checkout 代码到运行容器；设置 Python 3.11 环境；安装项目依赖；运行 app.py 脚本生成新图表；检查是否有变更；如有变更则提交并推送到仓库。

### 8.2 其他定时任务方案

如果需要更灵活的定时策略，可以考虑以下方案。腾讯云云函数支持定时触发，可编写类似的 Python 脚本部署到云函数，设置定时触发器每天执行。阿里云函数计算同样支持定时触发，且有免费额度，适合个人项目使用。

对于有自己服务器的用户，可以使用 Linux 的 crontab 设置定时任务。执行 `crontab -e` 编辑定时配置，添加 `0 9 * * * cd /path/to/project && python app.py` 表示每天上午 9 点执行。Windows 系统可以使用任务计划程序创建定时任务。

## 九、常见问题与排查

### 9.1 网络请求失败

如果运行时报错 "请求失败"，可能的原因包括：网络连接问题、本地 IP 被目标网站限制、目标服务器暂时不可用等。排查步骤：检查网络连接是否正常；尝试使用 VPN 或代理；检查是否触发了目标网站的访问频率限制；确认请求头设置正确。

### 9.2 图表不显示

如果生成 HTML 后图表不显示，可能的原因包括：pyecharts 版本不兼容、JavaScript 被浏览器拦截、资源文件路径错误等。排查步骤：使用浏览器开发者工具查看控制台错误信息；确保 pyecharts 版本与代码兼容；尝试在无广告拦截插件的浏览器中打开。

### 9.3 数据缺失

如果某个基金没有显示数据，可能的原因包括：基金代码错误、基金已下架或暂停、接口返回数据为空等。排查步骤：确认基金代码正确且基金仍在运作；检查接口返回的原始数据；查看程序日志中的警告信息。

## 十、扩展与优化建议

### 10.1 增加更多图表类型

当前项目只展示了折线图，可以扩展为支持多种图表类型。添加收益率柱状图对比不同基金的年化收益；添加相关性热力图分析基金之间的关联性；添加最大回撤图展示风险指标。

### 10.2 添加数据缓存

为了减少网络请求次数和加快运行速度，可以添加数据缓存机制。使用 SQLite 数据库存储历史数据，新数据与缓存数据合并后再生成图表。这样即使网络请求失败，也能展示缓存的历史数据。

### 10.3 邮件或消息通知

可以添加邮件或微信通知功能，在每日任务完成后发送执行结果通知。GitHub Actions 可以配置邮件提醒，告知任务执行成功或失败。对于更及时的通知，可以使用 Server 酱等工具发送微信消息。

### 10.4 参数化查询日期范围

当前代码只获取最近 20 条记录，可以通过配置文件添加日期范围参数。用户可以指定获取近一年、近三年或自定义时间范围的净值数据，满足不同分析需求。

---

本文档版本：1.0  
最后更新：2025年1月  
技术支持：如有问题可在 GitHub 仓库提交 Issue
